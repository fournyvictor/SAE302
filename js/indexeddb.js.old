
/******************************************************************************/
/* INTERACTIONS DB                                                            */
/******************************************************************************/

function onLikeButtonClick() {
    const DB = "FullBoxdDB";
    const REQUEST = indexedDB.open(DB, 1);

    REQUEST.onerror = onDBError;

    if (is_movie_liked) {
        REQUEST.onsuccess = onDBSuccessLikeRemove;
    } else {
        REQUEST.onsuccess = onDBSuccessLikeAdd;

    }

}
function onReviewButtonClick() {
    console.debug("AHAHAHA");
}
function checkIfMovieLiked() {
    const DB = "FullBoxdDB";
    const REQUEST = indexedDB.open(DB, 1);

    REQUEST.onupgradeneeded = onDBUgradeNeeded;

    REQUEST.onerror = onDBError;
    REQUEST.onsuccess = onDBSuccessCheckLike;

}

function onDBError(event) {
    console.error("Erreur IndexedDB:", event.target.error);
}
function onDBUgradeNeeded(event) {
    const DB = event.target.result;
    //creation de likes si non existant
    if (!DB.objectStoreNames.contains("likes")) {
        DB.createObjectStore("likes", { keyPath: "filmId" });
    }
    //creation de reviews si non existant
    if (!DB.objectStoreNames.contains("reviews")) {
        DB.createObjectStore("reviews", { keyPath: "filmId" });
    }
}
function onDBSuccessLikeAdd(event) {
    const DB = event.target.result;

    const TRANSACTION = DB.transaction(["likes"], "readwrite");
    const OBJECTSTORE = TRANSACTION.objectStore("likes");

    // ajout du film aux likes
    const ENTRY = { filmId: FILM_ID, addedAt: new Date() };
    const REQUEST = OBJECTSTORE.add(ENTRY);

    REQUEST.onsuccess = successfullyLiked;
    REQUEST.onerror = dbTransactionError;
}
function onDBSuccessLikeRemove(event) {
    const DB = event.target.result;

    const TRANSACTION = DB.transaction(["likes"], "readwrite");
    const OBJECTSTORE = TRANSACTION.objectStore("likes");

    // retirer le film des likes
    const REQUEST = OBJECTSTORE.delete(FILM_ID);

    REQUEST.onsuccess = successfullyUnLiked;
    REQUEST.onerror = dbTransactionError;
}
function onDBSuccessCheckLike(event) {
    const DB = event.target.result;

    const TRANSACTION = DB.transaction(["likes"], "readonly");
    const OBJECTSTORE = TRANSACTION.objectStore("likes");

    const REQUEST = OBJECTSTORE.get(FILM_ID);

    REQUEST.onsuccess = onCheckLikedResult;
    REQUEST.onerror = dbTransactionError;

}
function dbTransactionError(event) {
    console.error("erreur de transaction db : ", event.target.error);
}
function successfullyLiked() {
    console.log(`Film ${FILM_ID} ajouté aux likes !`);
    LIKE_BUTTON_IMAGE.src = "../Misc/icon_heart_full.svg"
    is_movie_liked = true;
}
function successfullyUnLiked() {
    console.log(`Film ${FILM_ID} retiré des likes !`)
    LIKE_BUTTON_IMAGE.src = "../Misc/icon_heart.svg"
    is_movie_liked = false;
}
function onCheckLikedResult(event) {
    const RESULT = event.target.result;

    if (RESULT) {
        console.log("Le film est liké");
        LIKE_BUTTON_IMAGE.src = "../Misc/icon_heart_full.svg"
        is_movie_liked = true;
    } else {
        LIKE_BUTTON_IMAGE.src = "../Misc/icon_heart.svg"
    }
}